<!DOCTYPE html>
<html>
<head>
    <title>LINE LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        input {
            margin: 10px;
            padding: 8px;
            font-size: 16px;
        }
    </style>    
</head>

<body>
    <div id="qrcode">
        <form id="userForm">
            <p>ver 1.1</p>
            <input type="email" id="email" placeholder="メールアドレス" required>
            <input type="tel" id="phone" placeholder="電話番号" required>
            <button type="submit">送信</button>
        </form>
    </div>

    <script>
        let userId = '';

        async function main() {
            await liff.init({ liffId: "2001381147-OALZKQMg" });

            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId; // userIdを取得して保持する
            }
        }

        // フォームの送信処理
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            if (userId) {
                const result = await submitForm(userId, email, phone);
                if (result) {
                    // 送信完了のアラート
                    alert('送信完了しました！');
                    // メッセージを送信
                    await sendMessage("LINE連携が完了しました");
                } else {
                    alert('送信に失敗しました。');
                }
                // LIFFウィンドウを閉じる（送信処理後）
                liff.closeWindow();
            } else {
                alert("User IDが取得できませんでした。");
            }
        });

        // データをスプレッドシートに送信する関数
        async function submitForm(userId, email, phone) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxT2i0EQ0MQEqK18QkFssieaNEiJCGZCFsAtFM-xVUMg83NQSGE91x-GyYXer2fuy5Z/exec';
            const data = { userId, email, phone };

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors', // CORSモードに変更
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // ステータスコードの確認
                if (response.ok) {
                    return true; // 送信成功
                } else {
                    console.error('送信に失敗しました:', response.statusText);
                    return false; // 送信失敗
                }
            } catch (error) {
                console.error('Error!', error);
                return false; // エラーが発生した場合
            }
        }

        // メッセージを送信する関数
        async function sendMessage(text) {
            try {
                await liff.sendMessages([{ type: "text", text }]);
                console.log("メッセージ送信成功");
            } catch (error) {
                console.log("メッセージ送信エラー", error);
            }
        }

        main();
    </script>

</body>
</html>
