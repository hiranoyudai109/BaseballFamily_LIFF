<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>

        /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        }


        .form-container {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 300px;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        h2 {
        color: #333;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        text-align: center;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        p.phone-number {
            color: #333;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
        width: 100%;
        max-width: 300px;
        padding: 12px;
        padding: 0.75rem;
        background-color: #333;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        }

        button:hover {
        background-color: #555;
        }

        button:active {
        transform: translateY(1px);
        }

        /* é€£æºä¸­...ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #loadingMessage {
            display: none;
            color: #666;
            text-align: center;
            margin-top: 1rem;
            font-style: italic;
        }
        
        /* ãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #successMessage {
            display: none;
            color: #4CAF50;
            text-align: center;
            margin-top: 1rem;
            font-weight: bold;
        }
    </style>    
</head>

<body>

    <div class="container">
        <header class="header">
            <h1>LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</h1>        
        </header>
        <main class="content">
            <form id="userForm">
                <h2>é›»è©±ç•ªå·</h2>
                <p class="phone-number" id="phoneDisplay"></p>
                <button class="btn" type="submit">LIENé€£æºã‚’å®Œäº†ã™ã‚‹</button>
                <p id="loadingMessage">é€£æºä¸­...</p>
                <p id="successMessage">LINEé€£æºãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
            </form>
        </main>
    </div>

<script>
        let userId = '';

        async function main() {
            await liff.init({ liffId: "2001381147-OALZKQMg" });

            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId;
            }

            const liffState = decodeURIComponent(window.location.search);
            const queryParams = new URLSearchParams(liffState);
            const phone = queryParams.get('phone');

            if (phone) {
                document.getElementById('phoneDisplay').textContent = phone;
            }
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const phone = document.getElementById('phoneDisplay').textContent;
            const submitButton = document.getElementById('submitButton');
            const loadingMessage = document.getElementById('loadingMessage');
            const successMessage = document.getElementById('successMessage');

            if (userId) {
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
                submitButton.disabled = true;
                submitButton.style.backgroundColor = '#cccccc';
                submitButton.style.cursor = 'not-allowed';

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                loadingMessage.style.display = 'block';

                const result = await submitForm(userId, phone);
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                loadingMessage.style.display = 'none';

                if (result) {
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    successMessage.style.display = 'block';
                    // 2ç§’å¾Œã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
                    setTimeout(() => {
                        liff.closeWindow();
                    }, 2000);
                } else {
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€ãƒœã‚¿ãƒ³ã¯ç„¡åŠ¹ã®ã¾ã¾ã«ã™ã‚‹
                    alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                }
            } else {
                alert("User IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        });

        async function submitForm(userId, phone) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxrOOHHNa7jfnexQG1OSVNXv1sucntdfh1ThOSQtRrOVeZjg3SYCiV7SxhoeEyEoaCd/exec';
            const data = { userId, phone };

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                await sendMessage("LINEé€£æºãŒå®Œäº†ã—ã¾ã—ãŸ");
                return true;
            } catch (error) {
                console.error('Error!', error);
                return false;
            }
        }

        async function sendMessage(text) {
            try {
                await liff.sendMessages([{ type: "text", text: "LINEé€£æºãŒå®Œäº†ã—ã¾ã—ãŸğŸ‘" }]);
                console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ");
            } catch (error) {
                console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼", error);
            }
        }

        main();
    </script>
</body>
</html>
