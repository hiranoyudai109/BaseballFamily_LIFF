<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>

        /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        }


        .form-container {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 300px;
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        h2 {
        color: #333;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        text-align: center;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        p.phone-number {
            color: #333;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
        width: 100%;
        max-width: 300px;
        padding: 12px;
        padding: 0.75rem;
        background-color: #333;
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        }

        button:hover {
        background-color: #555;
        }

        button:active {
        transform: translateY(1px);
        }
    </style>    
</head>

<body>

    <div class="container">
        <header class="header">
            <h1>LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</h1>        
        </header>
        <main class="content">
            <form id="userForm">
                <h2>é›»è©±ç•ªå·</h2>
                <p class="phone-number" id="phoneDisplay"></p>
                <button class="btn" type="submit">LIENé€£æºã‚’å®Œäº†ã™ã‚‹</button>
            </form>
        </main>
    </div>

    <script>
        let userId = '';

        async function main() {
            await liff.init({ liffId: "2001381147-OALZKQMg" });

            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId; // userIdã‚’å–å¾—ã—ã¦ä¿æŒã™ã‚‹
            }

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’å–å¾—
            // LIFF stateã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
            const liffState = decodeURIComponent(window.location.search); // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å…¨ä½“ã‚’å–å¾—
            const queryParams = new URLSearchParams(liffState); // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
            const phone = queryParams.get('phone'); // phoneã‚’å–å¾—

            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãŒå­˜åœ¨ã™ã‚Œã°ã€ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
                if (phone) {
                    document.getElementById('phoneDisplay').textContent = phone;
                }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const phone = document.getElementById('phoneDisplay').textContent;
            

            if (userId) {
                const result = await submitForm(userId, phone);
                if (result) {
                    alert('é€ä¿¡å®Œäº†ã—ã¾ã—ãŸï¼');
                }
            } else {
                alert("User IDãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        });

        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«é€ä¿¡ã™ã‚‹é–¢æ•°
        async function submitForm(userId, phone) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxQBuBoUol0J8kvBHvrBsNBJ2-E8n-k1k85tSXboxB1vbdV1_POO4yvbi9K8QaUirjb/exec';
            const data = { userId, phone };

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                sendMessage("LINEé€£æºãŒå®Œäº†ã—ã¾ã—ãŸ");

                // å¿œç­”ãŒæ­£å¸¸ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                alert('LINEé€£æºãŒå®Œäº†ã—ã¾ã—ãŸï¼');

                // LIFFã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
                liff.closeWindow();
                    
            } catch (error) {
                console.error('Error!', error);
                alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                return false;
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
        async function sendMessage(text) {
            try {
                await liff.sendMessages([{ type: "text", text: "LINEé€£æºãŒå®Œäº†ã—ã¾ã—ãŸğŸ‘" }]);
                console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æˆåŠŸ");
            } catch (error) {
                console.log("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼", error);
            }
        }

        main();
    </script>

</body>
</html>
