<!DOCTYPE html>
<html>
<head>
    <title>LINE LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        input {
            margin: 10px;
            padding: 8px;
            font-size: 16px;
        }
    </style>    
</head>

<body>
    <div id="qrcode">
        <form id="userForm">
            <input type="email" id="email" placeholder="メールアドレス" required>
            <input type="tel" id="phone" placeholder="電話番号" required>
            <button type="submit">送信</button>
        </form>
    </div>

    <script>
        let userId = '';

        async function main() {
            await liff.init({ liffId: "2001381147-OALZKQMg" });

            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId; // userIdを取得して保持する
            }

            // URLパラメーターを取得
            // LIFF stateからパラメータを取得
            const liffState = decodeURIComponent(window.location.search); // クエリパラメータ全体を取得
            const queryParams = new URLSearchParams(liffState); // パラメータを解析
            const phone = queryParams.get('phone'); // phoneを取得
            const email = urlParams.get('mail');

            // パラメーターが存在すれば、フォームの初期値として設定
            if (phone) {
                document.getElementById('phone').value = phone;
            }
            if (email) {
                document.getElementById('email').value = email;
            }
        }

        // フォームの送信処理
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;

            if (userId) {
                const result = await submitForm(userId, email, phone);
                if (result) {
                    alert('送信完了しました！');
                    // メッセージを送信
                    await sendMessage("LINE連携が完了しました");
                    // LIFFウィンドウを閉じる
                    liff.closeWindow();
                }
            } else {
                alert("User IDが取得できませんでした。");
            }
        });

        // データをスプレッドシートに送信する関数
        async function submitForm(userId, email, phone) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyJbYQ4oTFBIdDw76ozilJaPMS8Nkf0MiNQ7IrC2p4RYeaXGehn8u6Nv2Rqgo416vNq/exec';
            const data = { userId, email, phone };

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // 応答が正常であることを確認
                if (response.ok) {
                    return true;
                } else {
                    alert('送信に失敗しました。');
                    return false;
                }
            } catch (error) {
                console.error('Error!', error);
                alert('送信中にエラーが発生しました。');
                return false;
            }
        }

        // メッセージを送信する関数
        async function sendMessage(text == "LINE連携が完了しました！") {
            try {
                await liff.sendMessages([{ type: "text", text }]);
                console.log("メッセージ送信成功");
            } catch (error) {
                console.log("メッセージ送信エラー", error);
            }
        }

        main();
    </script>

</body>
</html>
