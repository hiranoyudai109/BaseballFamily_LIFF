<!DOCTYPE html>
<html>
<head>
    <title>LINE LIFF</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .text-gray {
            color: #333;
        }
    </style>    
</head>

<body>
    <div id="qrcode">
        <form id="userForm">
            <p class="text-gray">電話番号</p>
            <p class="text-gray" id="phoneDisplay"></p>
            <button type="submit">LIEN連携を完了する</button>
        </form>
    </div>

    <script>
        let userId = '';

        async function main() {
            await liff.init({ liffId: "2001381147-OALZKQMg" });

            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId; // userIdを取得して保持する
            }

            // URLパラメーターを取得
            // LIFF stateからパラメータを取得
            const liffState = decodeURIComponent(window.location.search); // クエリパラメータ全体を取得
            const queryParams = new URLSearchParams(liffState); // パラメータを解析
            const phone = queryParams.get('phone'); // phoneを取得

            // パラメーターが存在すれば、フォームの初期値として設定
                if (phone) {
                    document.getElementById('phoneDisplay').textContent = '電話番号: ' + phone;
                }
        }

        // フォームの送信処理
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const phone = document.getElementById('phoneDisplay').textContent;
            

            if (userId) {
                const result = await submitForm(userId, phone);
                if (result) {
                    alert('送信完了しました！');
                    // メッセージを送信
                    await sendMessage("LINE連携が完了しました");
                }
                // LIFFウィンドウを閉じる
                liff.closeWindow();
            } else {
                alert("User IDが取得できませんでした。");
            }
        });

        // データをスプレッドシートに送信する関数
        async function submitForm(userId, phone) {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxT2i0EQ0MQEqK18QkFssieaNEiJCGZCFsAtFM-xVUMg83NQSGE91x-GyYXer2fuy5Z/exec';
            const data = { userId, phone };

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                // 応答が正常であることを確認
                alert('LINE連携が完了しました！');
                    
            } catch (error) {
                console.error('Error!', error);
                alert('送信中にエラーが発生しました。');
                return false;
            }
        }

        // メッセージを送信する関数
        async function sendMessage(text) {
            try {
                await liff.sendMessages([{ type: "text", text }]);
                console.log("メッセージ送信成功");
            } catch (error) {
                console.log("メッセージ送信エラー", error);
            }
        }

        main();
    </script>

</body>
</html>


